(function(){Ember.Handlebars.helper("convert-markdown",function(e){var t=function a(e){return e.replace(/@([a-z\d_]+)/gi,'<a href="https://www.codechef.com/users/$1">@$1</a>')};return new Ember.Handlebars.SafeString(marked(t(e)))});Ember.TEMPLATES["defaultItemContainer"]=Ember.Handlebars.compile("{{text}}");Ember.TEMPLATES["components/ember-comment"]=Ember.Handlebars.compile(""+'<section class="cc-comments-section">'+'<div class="comment-topmost-header"><h2 class="noselect cc-comments-title" {{action "expend"}}>Comments '+"{{#if expended}}"+'<i class="fa fa-caret-right active"></i>'+"{{else}}"+'<i class="fa fa-caret-right"></i>'+"{{/if}}"+"</h2>"+"{{#if showRetryBox}}"+'<p class="retry-banner">{{retryBoxMsg}} <a {{action "fetchComments"}}>Refresh</a></p>'+"{{/if}}"+"</div>"+"{{#if showComment}}"+"{{#if can_post}}"+'<div class="post-box">'+'<span style="font-weight:bold;color:#777;">Need help? Post a comment. But before that please spare a moment to read the <a href="http://discuss.codechef.com/questions/855/what-kind-of-comment-should-i-post-on-the-problem-page" target="_blank">guidelines</a>.</span>'+'<div class="clearfix cc-new-comment-container">'+'<div class="cc-new-comment-left">'+'{{textarea value=replyText readonly=textBoxDisabled class="comment-create-new"}}'+"{{#if previewMode}}"+'<div class="preview-container">'+'<div class="preview-header">Preview <a {{action "tooglePreview" this}}><i class="fa fa-eye-slash"></i></a></div>'+'<p class="preview-body markdown-body">{{convert-markdown replyText}}</p>'+"</div>"+"{{/if}}"+"{{#if textBoxDisabled}}"+'<a>Posting... <i class="fa fa-spinner fa-pulse"></i></a>'+"{{else}}"+'<a class="preview-button-top" {{action "tooglePreview" this}}>'+"{{#if previewMode}}"+'<i class="fa fa-eye-slash"></i>'+"{{else}}"+'<i class="fa fa-eye"></i>'+"{{/if}} Preview</a>"+'<input class="ns-button post-button" value="Post" type="submit" {{action "postReply" this}}>'+"{{/if}}"+"</div>"+'<div class="cc-new-comment-right">'+'<ul class="noselect cc-comment-instructions">'+'<li><b class="post-box-help">Help:</b></li>'+'<li class="post-box-help-sub">Supports <a href="https://discuss.codechef.com/markdown_help/">markdown</a></li>'+'<li class="post-box-help-sub">Supports @mention e.g <a {{action "addToReply" "@admin, "}}>@admin</a></li>'+"</ul>"+"</div>"+"</div>"+"</div>"+"{{/if}}"+"{{#each comment in comments}}"+'<article class="cc-comment-level-1">'+'<div {{bind-attr class="comment.commentClass"}}>'+'{{#if ../has_avatar}}<img class="cc-avatar" {{bind-attr src=comment.author_image}}" />{{/if}}'+'<div {{bind-attr class="comment.commentDetailsClass"}}>'+'<div style="float:left; width: 100%">   '+'<header class="noselect">'+'<h4 class="comment-author"><a {{bind-attr href=comment.author_url}}">{{comment.author}}</a></h4>'+'<p class="comment-datetime" {{bind-attr title=comment.timestamp}}>{{comment.timeago}}</p>'+"</header>"+'<p class="markdown-body">{{convert-markdown comment.message}}</p>'+'<div class="cc-edit-comment-container">'+"{{#if ../is_mod}}"+'<a href="#" {{action "replyopen" comment}}>Reply<i class="fa fa-reply"></i></a>'+"{{#if comment.unpublished}}"+'<a href="#" {{action "publish" comment}}>Publish<i class="fa fa-minus-circle"></i></a>'+"{{else}}"+'<a href="#" {{action "unpublish" comment}}>Unpublish<i class="fa fa-minus-circle"></i></a>'+"{{/if}}"+'<a href="#" {{action "archive" comment}}>Archive<i class="fa fa-archive"></i></a>'+"{{else}}"+'<a href="#" {{action "replyopen" comment}}>Reply<i class="fa fa-reply"></i></a>'+"{{/if}}"+"</div>"+"</div>"+"{{#each reply in comment.replies}}"+'<article class="cc-comment-level-2">'+'<div {{bind-attr class="reply.commentClass"}}>'+'{{#if ../has_avatar}}<img class="cc-avatar" {{bind-attr src=reply.author_image}}" />{{/if}}'+'<div {{bind-attr class="reply.commentDetailsClass"}}>'+'<header class="noselect">'+'<h4 class="comment-author"><a {{bind-attr href=reply.author_url}}">{{reply.author}}</a></h4>'+'<p class="comment-datetime" {{bind-attr title=reply.timestamp}}>{{reply.timeago}}</p>'+"</header>"+'<p class="markdown-body">{{convert-markdown reply.message}}</p>'+'<div class="noselect cc-edit-comment-container">'+"{{#if ../is_mod}}"+'<a href="#" {{action "replyopen" reply}}>Reply<i class="fa fa-reply"></i></a>'+"{{#if reply.unpublished}}"+'<a href="#" {{action "publish" reply}}>Publish<i class="fa fa-minus-circle"></i></a>'+"{{else}}"+'<a href="#" {{action "unpublish" reply}}>Unpublish<i class="fa fa-minus-circle"></i></a>'+"{{/if}}"+'<a href="#" {{action "archive" reply}}>Archive<i class="fa fa-archive"></i></a>'+"{{else}}"+'<a href="#" {{action "replyopen" reply}}>Reply<i class="fa fa-reply"></i></a>'+"{{/if}}"+"</div>"+"</div>"+"</div>"+"{{#if reply.replyboxOn}}"+'<div class="clearfix cc-new-comment-container">'+'{{textarea id=reply.textBoxId readonly=reply.textBoxDisabled value=reply.replyText class="comment-create-new"}}'+"{{#if reply.previewMode}}"+'<div class="preview-container">'+'<div class="preview-header">Preview <a {{action "tooglePreview" reply}}><i class="fa fa-eye-slash"></i></a></div>'+'<p class="preview-body markdown-body">{{convert-markdown reply.replyText}}</p>'+"</div>"+"{{/if}}"+'<div class="noselect cc-edit-comment-container">'+"{{#if reply.textBoxDisabled}}"+'<a>Posting...<i class="fa fa-spinner fa-pulse"></i></a>'+"{{else}}"+'<input class="ns-button post-button" style="float: none;" value="Post" type="submit" {{action "postReply" reply}}>'+'<a {{action "replyopen" reply}}>Cancel</i></a>'+'<a {{action "tooglePreview" reply}}>'+"{{#if reply.previewMode}}"+'<i class="fa fa-eye-slash"></i>'+"{{else}}"+'<i class="fa fa-eye"></i>'+"{{/if}}Preview</a>"+"{{/if}}"+"</div>"+"</div>"+"{{/if}}"+"</article>"+"{{/each}}"+"</div>"+"</div>"+"{{#if comment.replyboxOn}}"+'<div class="clearfix cc-new-comment-container">'+'{{textarea id=comment.textBoxId readonly=comment.textBoxDisabled value=comment.replyText class="comment-create-new"}}'+"{{#if comment.previewMode}}"+'<div class="preview-container">'+'<div class="preview-header">Preview <a {{action "tooglePreview" comment}}><i class="fa fa-eye-slash"></i></a></div>'+'<p class="preview-body markdown-body">{{convert-markdown comment.replyText}}</p>'+"</div>"+"{{/if}}"+'<div class="noselect cc-edit-comment-container">'+"{{#if comment.textBoxDisabled}}"+'<a>Posting...<i class="fa fa-spinner fa-pulse"></i></a>'+"{{else}}"+'<input class="ns-button post-button" style="float: none;" value="Post" type="submit" {{action "postReply" comment}}>'+'<a {{action "replyopen" comment}}>Cancel</a>'+'<a {{action "tooglePreview" comment}}>'+"{{#if comment.previewMode}}"+'<i class="fa fa-eye-slash"></i>'+"{{else}}"+'<i class="fa fa-eye"></i>'+"{{/if}}Preview</a>"+"{{/if}}"+"</div>"+"</div>"+"{{/if}}"+"</article>"+"{{else}}"+'<div class="noselect cc-comment-details"><p>No comments. Be the first to comment ?</p></div>'+"{{/each}}"+"{{else}}"+'{{#if expended}}<i class="fa fa-spinner fa-pulse"></i> Loading...{{/if}}'+"{{/if}}"+"</section>");var e=function(t){return $.ajax({dataType:t["dataType"]?t["dataType"]:"JSON",url:t["url"],type:t["type"]?t["type"]:"GET",data:t["data"],retryCount:t["retryCount"]?t["retryCount"]:0,retryLimit:10,success:function(e){if(typeof t["success"]=="function"){t["success"](e)}},error:function(a){if(a.status>498&&this.retryCount<this.retryLimit){t["retryCount"]=t["retryCount"]?t["retryCount"]+1:1;setTimeout(function(){e(t)},2e3)}else{if(typeof t["error"]=="function"){t["error"](a)}}}})};var t=Ember.Object.extend({replies:null,replyText:"",previewMode:false,textBoxDisabled:false,textBoxId:function(){return"reply-"+this.get("id")}.property("id"),commentClass:function(){var e=["clearfix"];if(this.get("important"))e.push("cc-comment-important");if(this.get("unpublished"))e.push("cc-comment-unpublished");if(this.get("author_avatar")==""&&this.get("pid")!="0")e.push("cc-without-image");return e.join(" ")}.property("unpublished"),commentDetailsClass:function(){var e=["cc-comment-details"];if(this.get("author_avatar")!="")e.push("cc-comment-details-margin-push");return e.join(" ")}.property("author_avatar"),replyboxOn:false,message:function(){var e=this.get("content");e.replace(/\n\r?/g,"<br />");return e}.property("content"),author_url:function(){return"/users/"+this.get("author")}.property("author"),author_image:function(){var e=this.get("author_avatar");if(e)return e;else return"/em/components/comment/images/avatar.png"}.property("author_avatar"),timeago:function(){return moment(this.get("time")*1e3).fromNow()}.property("time"),timestamp:function(){return moment(this.get("time")*1e3).format("MMMM Do YYYY, h:mm:ss a")}.property("time")});var a=Ember.Component.extend({didInsertElement:function(){this._super();var e=this;getUserKey().then(function(t){e.set("cacheKey",t);var a=cacheClass.getGlobalCache("comment-cache",t);e.set("commentsCache",a)})},previewMode:false,expended:false,comments:[],showRetryBox:false,retryBoxMsg:function(){var e=moment(this.get("lastFetch")).fromNow();return"Comments were last fetched "+e.toString()+"."}.property("timer"),replyText:"",textBoxDisabled:false,fetchURL:"/comment/fetch/url",postURL:"/comment/add/url",publishURL:"/comment/publish",unpublishURL:"/comment/unpublish",archiveURL:"/comment/moderator/archive",currentURL:window.location.href,downloaded:0,buildViewURL:function(){var e=this.get("fetchURL");var t=window.location.href}.property("fetchURL"),showComment:function(){if((this.get("downloaded")==1||this.get("downloaded")==0&&this.get("comments").length>0)&&this.get("expended"))return true;return false}.property("expended","downloaded"),processData:function(e){for(var a=0;a<i;a++){e[a].sid=parseInt(e[a].id)}e=e.sortBy("sid");var i=e.length;var s=[];for(var a=0;a<i;a++){e[a].id=""+e[a].id;e[a].pid=""+e[a].pid;if(e[a].pid=="0"){s[e[a].id]=t.create(e[a])}else{var r=s[e[a].pid];if(!Ember.isEmpty(r)){var n=r.get("replies");if(Ember.isEmpty(n)){n=Ember.A()}n.push(t.create(e[a]));r.set("replies",n)}}}s=Object.keys(s).map(function(e){return s[e]});s=s.sortBy("sid").reverse();this.set("comments",s)},quickHash:function(e){var t=0,a,i,s;if(e.length==0)return t;for(a=0,s=e.length;a<s;a++){i=e.charCodeAt(a);t=(t<<5)-t+i;t|=0}return t},updateDataToCache:function(){var e=this.get("commentsCache");var t=""+this.quickHash(this.get("currentURL"));e.update(t,this.get("data"),30)},afterFetchProcess:function(){var e=this.get("data");var t=this;this.processData(e.list);this.set("is_mod",e.is_mod);this.set("has_avatar",e.has_avatar);this.set("downloaded",1);this.set("lastFetch",(new Date).getTime());this.set("showRetryBox",false);this.set("can_post",e.can_post);Ember.run.later(function(){t.set("showRetryBox",true);t.set("timer",0)},5e3);setInterval(function(){t.set("timer",t.get("timer")+1)},1e3)},fetchCommentsRaw:function(){var t=this;var a=function(e){if(e.status=="success"){t.set("data",e);t.updateDataToCache();t.afterFetchProcess()}};e({type:"GET",url:this.get("fetchURL"),data:{url:this.get("currentURL"),page:this.get("page"),limit:this.get("limit")},success:a})},fetchComments:function(e){if(typeof e=="undefined")e=false;var t=this.get("commentsCache");var a=""+this.quickHash(this.get("currentURL"));var i=t.get(a);var s=this;if(Ember.isEmpty(i)||e){s.fetchCommentsRaw(true)}else{s.set("data",i);s.afterFetchProcess()}},actions:{expend:function(e){if(this.get("downloaded")==0){this.set("downloaded",-1);this.fetchComments()}this.toggleProperty("expended")},addToReply:function(e){this.set("replyText",this.get("replyText")+e)},fetchComments:function(e){this.fetchComments(false)},replyopen:function(e){e.toggleProperty("replyboxOn");window.setTimeout(function(){var t=document.getElementById(e.get("textBoxId"));if(t){t.focus();e.set("previewMode",false)}},0)},tooglePreview:function(e){e.toggleProperty("previewMode")},publish:function(t){var a=this;e({type:"GET",url:this.get("publishURL")+"/"+t.get("id"),success:function(){t.set("unpublished",0);a.fetchComments(true)}})},unpublish:function(t){var a=this;e({type:"GET",url:this.get("unpublishURL")+"/"+t.get("id"),success:function(){t.set("unpublished",1);a.fetchComments(true)}})},archive:function(t){var a=this;var i=function(e){if(e.status=="success"){a.fetchComments(true);a.set("replyopen",false)}else{alert("something went wrong")}};e({type:"GET",url:this.get("archiveURL")+"/"+t.get("id"),success:i})},postReply:function(t){if(t.get("textBoxDisabled"))return;if(t.get("replyText").length<1)return;t.set("textBoxDisabled",true);var a=this;var i=function(e){if(e.status=="success"){a.fetchComments(true);a.sendAction("replyopen",a.get("param"));if(a==t){window.setTimeout(function(){t.set("textBoxDisabled",false);t.set("replyText","")},0)}}else{t.set("textBoxDisabled",false)}};var s=t.get("pid");if(s=="0"){s=t.get("id")}e({type:"POST",url:this.get("postURL"),data:{comment:t.get("replyText"),pid:s,url:this.get("currentURL")},success:i})}}});Ember.Application.initializer({name:"comment-component",initialize:function(e,t){e.register("component:ember-comment",a)}})})();